{
    "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "Custom Image Build",
            "steps": [
                {
                    "name": "basics",
                    "label": "Deployment Basics",
                    "elements": [
						{
							"name": "infoPreReq",
							"type": "Microsoft.Common.InfoBox",
							"visible": true,
							"options": {
								"style": "Info",
								"text": "PREREQUISITES REQUIRED \n\nThere are prerequisites that must be setup in your Azure environment to successfully deploy this Custom Image Build. The prerequisites are outlined on the 'Prerequisites' page."
							}
						},
						{
                            "name": "scope",
                            "type": "Microsoft.Common.ResourceScope",
							"instanceDetailsLabel": "Image Build Location",
							"location": {
								"label": "Region (for Image Build resources)",
                                "resourceTypes": ["Microsoft.Compute/virtualmachines"]
                            }
                        },
						{
							"name": "resGroup",
							"type": "Microsoft.Common.Section",
							"label": "Image Build Resource Group",
							"elements": [
								{
									"name": "useExResGroup",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Use Existing Resource Group",
									"defaultValue": "Yes",
									"toolTip": "",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									}
								},
								{
                                    "name": "resourceGroupsApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('basics').scope.subscription.id, '/resourceGroups?api-version=2021-04-01')]"
                                    }
                                },
                                {
                                    "name": "resourceGroup",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Resource Group (for Image Build resources)",
                                    "toolTip": "Select the name of the existing resource group where the image build virtual machines and associated resources will be created.",
                                    "constraints": {
                                        "allowedValues": "[map(steps('basics').resGroup.resourceGroupsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
                                        "required": true
                                    },
                                    "visible": "[equals(steps('basics').resGroup.useExResGroup, true)]"
                                },
								{
									"name": "customBuildResourceGroupName",
									"type": "Microsoft.Common.TextBox",
									"label": "Custom Build Resource Group Name",
									"subLabel": "Leave blank if you want to allow this deployment to create a resource group automatically named with CAF principals.",
									"placeholder": "rg-image-build-resources-<environment>-<location>",
									"toolTip": "The custom name of the resource group where the image build and management vms will be created.",
									"constraints": {
										"required": false,
										"regex": "^[a-z0-9A-Z-]{2,90}$",
										"validationMessage": "If provided the value must be between 2 and 90 characters."
									},
									"visible": "[equals(steps('basics').resGroup.useExResGroup, false)]"
								}
							]
						},
						{
                            "name": "computeApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "[concat(steps('basics').scope.subscription.id,'/providers/Microsoft.Compute/resourceTypes?api-version=2021-04-01')]"
                            }
                        },
                        {
                            "name": "locationsApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "[concat(steps('basics').scope.subscription.id,'/locations?api-version=2020-01-01')]"
                            }
                        },
                        {
                            "name": "storageApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "[concat(steps('basics').scope.subscription.id,'/providers/Microsoft.Storage/resourceTypes?api-version=2021-04-01')]"
                            }
                        },
						{
							"name": "deploymentSpecs",
							"type":"Microsoft.Common.Section",
							"visible": true,
							"label": "Deployment Specifications",
							"elements":[
								{
									"name": "deploymentPrefix",
									"type": "Microsoft.Common.TextBox",
									"label": "Deployment Prefix",
									"subLabel": "",
									"placeholder": "imgbld",
									"toolTip": "Provide a prefix (from 2 to 6 characters) for the deployments created by this template.",
									"constraints": {
										"required": true,
										"regex": "^[a-z0-9A-Z-]{2,6}$",
										"validationMessage": "The prefix must be between 2 and 6 characters"
									}
								},                       
								{
									"name": "envClassification",
									"type": "Microsoft.Common.DropDown",
									"label": "Env Classification",
									"defaultValue": "Not Defined",
									"toolTip": "Select the type of environment (Development (dev), Test (test), Production (prod)) for which this solution is being deployed. This information will be use as part of the resources naming. Select (or leave the value as) \"Not Specified\" to omit this option.",
									"constraints": {
										"required": false,
										"allowedValues": [
											{
												"label": "Not Defined",
												"value": ""
											},
											{
												"label": "Development",
												"value": "dev"
											},
											{
												"label": "Test",
												"value": "test"
											},
											{
												"label": "Production",
												"value": "prod"
											}
										]
									}
								}
							]
						}
					]
				},
				{
					"name": "prereqs",
					"label": "Imaging Prerequisites and Resources",
					"elements": [
						{
							"name": "infoPreReq",
							"type": "Microsoft.Common.InfoBox",
							"options": {
								"style":"Warning",
								"text": "Prior to deployment, make sure you meet the prerequisites outlined in the resource pre-reqs section in Zero Trust Image solution documentation:",
								"uri": "https://github.com/mikedzikowski/ZTAImage#prequisites"
							}
						},
						{
							"name": "textBlockStorageAndManagedIdentity",
							"type": "Microsoft.Common.TextBlock",
							"visible": true,
							"options": {
								"text": "Select the storage account and blob container with the build artifacts (scripts and installers) and the User Assigned Managed Identity that has been assigned the 'Storage Blob Data Reader' role the storage account.<br/><br/>The User Assigned Identity will be assigned the Contributor and Storage Blob Data Contributor roles on the Build Resource Group."
							}
						},						
						{
							"name": "storage",
							"type": "Microsoft.Common.Section",
							"label": "Storage Account",
							"elements": [
								{
									"name": "storageAccount",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "Image Artifacts Storage Account",
									"resourceType": "Microsoft.Storage/storageAccounts",
									"toolTip": "Select the storage account containing the image customization artifacts (i.e., installers, scripts)."
								},
								{
									"name": "containerApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('prereqs').storage.storageAccount.id, '/blobServices/default/containers?api-version=2023-01-01')]"
									}
								},
								{
									"name": "container",
									"type": "Microsoft.Common.DropDown",
									"visible": true,
									"label": "Image Artifacts Container",
									"defaultValue": "",
									"toolTip": "Select the container which contains the software and script blobs.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(steps('prereqs').storage.containerApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\"}')))]"
									}
								},
								{
									"name": "managedIdentity",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "User Assigned Identity",
									"toolTip": "Select an existing User Assigned Identity which has been assigned data plane rights of at least 'Storage Blob Data Reader' to the storage account and container selected above.",
									"resourceType": "Microsoft.ManagedIdentity/userAssignedIdentities",
									"constraints": {
										"required": true
									}
								}
							]
						},
						{
							"name": "network",
							"type": "Microsoft.Common.Section",
							"label": "Networking",
							"elements": [
								{
									"name": "textBlockNetwork",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "Select the Virtual Network and Subnet to which the image build virtual machine will be attached. The Virtual Network options listed below are based on the region selected under 'Image Build Location' on the 'Deployment Basics' page. If you don't find the desired virtual network, change the region on the 'Basics' page."
									}									
								},
								{
									"name": "warningNetwork",
									"type": "Microsoft.Common.InfoBox",
									"options": {
										"style":"Warning",
										"text": "Virtual machines must be able to resolve the blob private dns zone and route to the storage account endpoint for the storage account selected above. Select the appropriate subnet that meets these requirements."
									}
								},
								{
									"name": "virtualNetworksApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('basics').scope.subscription.id, '/providers/Microsoft.Network/virtualNetworks?api-version=2022-11-01')]"
									}
								},
								{
									"name": "virtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"visible": true,
									"label": "Image Capture Virtual Network",
									"defaultValue": "",
									"toolTip": "Select an existing virtual network to attach the VM for image capture. If the desired network isn't available be sure to change the region in the Deployment Details section above.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(filter(steps('prereqs').network.virtualNetworksApi.value, (item) => equals(item.location, steps('basics').scope.location.name)), (item) => parse(concat('{\"label\":\"', item.name, '\",\"description\":\"Resource group: ', first(skip(split(item.id, '/'), 4)), '\",\"value\":\"', item.id, '\"}')))]"
									}
								},
								{
									"name": "subnetsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('prereqs').network.virtualNetwork, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "subnet",
									"type": "Microsoft.Common.DropDown",
									"visible": true,
									"label": "Image Capture Subnet",
									"defaultValue": "",
									"toolTip": "Select an existing subnet for the image capture.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(steps('prereqs').network.subnetsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\"}')))]"
									}
								}
							]
						},
						{
							"name": "gallery",
							"type": "Microsoft.Common.Section",
							"label": "Azure Compute Gallery",
							"elements": [
								{
									"name": "gallery",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "Select the existing Compute Gallery",
									"resourceType": "Microsoft.Compute/galleries"
								}
							]
						}				
					]
				},
				{
					"name": "imageVm",
					"label": "Image Virtual Machine",
					"elements": [
						{
							"name": "vmProps",
							"type": "Microsoft.Common.Section",
							"label": "Virtual Machine Properties",
							"elements": [
                        		{
									"name": "vmSize",
									"type": "Microsoft.Compute.SizeSelector",
									"label": "Virtual Machine Size",
									"toolTip": "",
									"recommendedSizes": [
										"Standard_D4ads_v5"
									],
									"options": {
										"hideDiskTypeFilter": false
									},
									"osPlatform": "Windows",							
									"visible": true
								},
								{
                                    "name": "osVersion",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Operating System Version",
                                    "filter": true,
                                    "defaultValue": "Windows 11 22H2 (Gen2)",
                                    "toolTip": "Select the operating system version for the source image.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
											{
                                                "label": "Windows 10 22H2 Enterprise (Gen1)",
                                                "value": "MicrosoftWindowsDesktop_windows-10_win10-22h2-ent"
                                            },                                            
											{
                                                "label": "Windows 10 22H2 Multi-Session (Gen1)",
                                                "value": "MicrosoftWindowsDesktop_windows-10_win10-22h2-avd"
                                            },
                                            {
                                                "label": "Windows 10 22H2 Multi-Session with M365 Apps (Gen1)",
                                                "value": "MicrosoftWindowsDesktop_office-365_win10-22h2-avd-m365"
                                            },
											{
                                                "label": "Windows 10 22H2 Enterprise (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-10_win10-22h2-ent-g2"
                                            },                                            
											{
                                                "label": "Windows 10 22H2 Multi-Session (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-10_win10-22h2-avd-g2"
                                            },
                                            {
                                                "label": "Windows 10 22H2 Multi-Session with M365 Apps (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_office-365_win10-22h2-avd-m365-g2"
                                            },
											{
                                                "label": "Windows 11 21H2 Enterprise (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-11_win11-21h2-ent"
                                            },                                            
											{
                                                "label": "Windows 11 21H2 Multi-Session (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-11_win11-21h2-avd"
                                            },
                                            {
                                                "label": "Windows 11 21H2 Multi-Session with M365 Apps (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_office-365_win11-21h2-avd-m365"
                                            },
																						{
                                                "label": "Windows 11 22H2 Enterprise (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-11_win11-22h2-ent"
                                            },                                            
											{
                                                "label": "Windows 11 22H2 Multi-Session (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-11_win11-22h2-avd"
                                            },
                                            {
                                                "label": "Windows 11 22H2 Multi-Session with M365 Apps (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_office-365_win11-22h2-avd-m365"
                                            }
                                        ]
                                    }
                                }
							]							
						}						
					]
				},
				{
					"name": "imageCustomizations",
                    "label": "Image Customizations",
                    "elements": [
						{
							"name": "infoBox1",
							"type": "Microsoft.Common.InfoBox",
							"visible": true,
							"options": {
								"style": "Info",
								"text": "This page of the wizard allows you to add image customizations by downloading blobs from the storage account and performing the defined actions."
							}
						},
						{
							"name": "customSoftware",
							"type": "Microsoft.Common.Section",
							"label": "Custom Software",
							"elements": [
								{
									"name": "addCustomSoftware",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Add Custom Software",
									"defaultValue": "No",
									"toolTip": "Select 'Yes' to add custom software to the image",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "customizationText",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('imageCustomizations').customSoftware.addCustomSoftware]",
									"options": {
										"text": "Enter customizations for your image below. The first column is a free-form text field that can only contain alphanumerics and no spaces. The second column is the blob name and is case-sensitive. The third column is for any arguments."
									}
								},								
								{
									"name": "customizations",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Customizations",
									"label": "Custom Scripts and Software",
									"visible": "[steps('imageCustomizations').customSoftware.addCustomSoftware]",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 0,
												"max": 10
											}
										},
										"columns": [
											{
												"id": "name",
												"header": "Name",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "Example: vscode",
													"constraints": {
														"required": true,
														"validations": []
													}
												}
											},
											{
												"id": "blobname",
												"header": "Blobname",
												"width": "10fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "Example: VSCodeSetup-x64-1.81.1.exe",
													"constraints": {
														"allowedValues": [
															{
																"label": "blobname",
																"value": "text"
															}
														],
														"required": true
													}
												}
											},
											{
												"id": "arguments",
												"header": "Arguments",
												"width": "10fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "Example: /silent /mergetasks='!runcode'",
													"constraints": {
														"allowedValues": [
															{
																"label": "arguments",
																"value": "text"
															}
														],
														"required": false 
													}
												}
											}
										]
									}
								}
							],
							"visible": true
						},
						{
                            "name": "office",
                            "type": "Microsoft.Common.Section",
                            "label": "Software",
                            "elements": [
                                {
                                    "name": "installOffice",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install Office",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Office",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    }
                                },
                                {
                                    "name": "officeBlob",
                                    "type": "Microsoft.Storage.StorageBlobSelector",
                                    "visible": "[steps('imageCustomizations').office.installOffice]",
                                    "toolTip": "Select Microsoft Office Customization Tool blob",
                                    "label": "Office Deployment Tool (.zip)",
                                    "options": {
                                        "text": "Select Package"
                                    },
                                    "constraints": {
                                        "allowedFileExtensions": [
                                            "zip"
                                        ]
                                    }
                                },
                                {
                                    "name": "installAccess",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "InstallAccess",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Access",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": "[steps('imageCustomizations').office.installOffice]"
                                },
                                {
                                    "name": "installExcel",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "installExcel",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Excel",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": "[steps('imageCustomizations').office.installOffice]"
                                },
                                {
                                    "name": "installOneNote",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install OneNote",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install OneNote",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": "[steps('imageCustomizations').office.installOffice]"
                                },
                                {
                                    "name": "installOutlook",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install Outlook",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Outlook",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": "[steps('imageCustomizations').office.installOffice]"
                                },
                                {
                                    "name": "installPowerPoint",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install PowerPoint",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to Install PowerPoint",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": "[steps('imageCustomizations').office.installOffice]"
                                },
                                {
                                    "name": "installProject",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install Project",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Project",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": "[steps('imageCustomizations').office.installOffice]"
                                },
                                {
                                    "name": "installPublisher",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install Publisher",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Publisher",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": "[steps('imageCustomizations').office.installOffice]"
                                },
                                {
                                    "name": "installSkypeForBusiness",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install Skype For Business",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Skype For Business",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": "[steps('imageCustomizations').office.installOffice]"
                                },
                                {
                                    "name": "installVisio",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "installVisio",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Visio",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": "[steps('imageCustomizations').office.installOffice]"
                                },
                                {
                                    "name": "installWord",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install Word",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Word",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": "[steps('imageCustomizations').office.installOffice]"
                                },
								{
                                    "name": "installOneDrive",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install OneDrive (Per Machine)",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install OneDrive (Per-Machine)",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "onedriveBlob",
                                    "type": "Microsoft.Storage.StorageBlobSelector",
                                    "visible": "[steps('imageCustomizations').office.installOneDrive]",
                                    "toolTip": "Select Mirosoft OneDrive blob",
                                    "label": "OneDrive Setup (.zip)",
                                    "options": {
                                        "text": "Select Package"
                                    },
                                    "constraints": {
                                        "allowedFileExtensions": [
                                            "zip"
                                        ]
                                    }
                                },
                                {
                                    "name": "installTeams",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install Teams",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Teams",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "teamsBlob",
                                    "type": "Microsoft.Storage.StorageBlobSelector",
                                    "visible": "[steps('imageCustomizations').office.installTeams]",
                                    "toolTip": "Select Mirosoft Teams blob",
                                    "label": "Teams Installers (.zip)",
                                    "options": {
                                        "text": "Select Package"
                                    },
                                    "constraints": {
                                        "allowedFileExtensions": [
                                            "zip"
                                        ]
                                    }
                                },
                                {
                                    "name": "installVirtualDesktopOptimizationTool",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install Virtual Desktop OptimizationTool",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install Virtual Desktop OptimizationTool",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "vDotBlob",
                                    "type": "Microsoft.Storage.StorageBlobSelector",
                                    "visible": "[steps('imageCustomizations').office.installVirtualDesktopOptimizationTool]",
                                    "toolTip": "Select vDot blob",
                                    "label": "VDOT Package (.zip)",
                                    "options": {
                                        "text": "Select Package"
                                    },
                                    "constraints": {
                                        "allowedFileExtensions": [
                                            "zip"
                                        ]
                                    }
                                }
                            ]
                        },
						{
                            "name": "updates",
                            "type": "Microsoft.Common.Section",
                            "label": "Software Updates",
                            "elements": [
                                {
                                    "name": "installUpdates",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Install Windows Updates",
                                    "defaultValue": "false",
                                    "toolTip": "Select True to install updates and specify an update source.",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "true",
                                                "value": true
                                            },
                                            {
                                                "label": "false",
                                                "value": false
                                            }
                                        ],
                                        "required": true
                                    }
                                },
								{
                                    "name": "updateService",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Software update service",
                                    "defaultValue": "Microsoft Update",
                                    "toolTip": "Select the appropriate update source for your environment.",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Microsoft Update",
                                                "value": "MU"
                                            },
                                            {
                                                "label": "Windows Update",
                                                "value": "WU"
                                            },
											{
												"label": "Windows Server Update Services (WSUS)",
												"value": "WSUS"
											},
											{
												"label": "DCAT (Flighting updates like previews, rarely used)",
												"value": "DCAT"
											},
											{
												"label": "Microsoft Store",
												"value": "STORE"
											},
											{
												"label": "Other",
												"value": "OTHER"
											}
                                        ],
                                        "required": false
                                    },
									"visible": "[if(equals(steps('imageCustomizations').updates.installUpdates, true), true, false)]"
                                },
								{
									"name": "wsusServer",
									"type": "Microsoft.Common.TextBox",
									"label": "WSUS Url",
									"placeholder": "https://wsus.corp.contoso.com:8531",
									"toolTip": "Specify an accessible WSUS server. Include the port if necessary.",
									"constraints": {
										"required": true
									},
									"visible": "[if(equals(steps('imageCustomizations').updates.updateService, 'WSUS'), true, false)]"
								}
							]
						},
						{
							"name": "logging",
							"type": "Microsoft.Common.Section",
							"label": "Log Collection",
							"elements": [
								{
									"name": "infoBox",
									"type": "Microsoft.Common.InfoBox",
									"visible": true,
									"options": {
										"style": "Info",
										"text": "If you choose to collect logs, a new randomly-named storage account will be created in the build resource group with a blob container called 'image-customization-logs'. All standard and error output will be written to individual blobs and saved for 7 days."
									}
								},
								{
									"name": "warningBox",
									"type": "Microsoft.Common.InfoBox",
									"visible": true,
									"options": {
										"style": "Warning",
										"text": "In order to collect logs from the customization scripts and installers you must provide the subnet where the storage account private endpoint will be created and the blob storage private dns zone.",										"uri": "https://www.microsoft.com"
									}
								},
								{
									"name": "collectLogs",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Collect customization logs in a storage container",
									"defaultValue": "No",
									"toolTip": "",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "virtualNetworksApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('basics').scope.subscription.id, '/providers/Microsoft.Network/virtualNetworks?api-version=2022-11-01')]"
									}
								},
								{
									"name": "virtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"visible": "[if(equals(steps('imageCustomizations').logging.collectLogs, true),true, false)]",
									"label": "Virtual Network",
									"defaultValue": "",
									"toolTip": "Select an existing virtual network for the storage account blob private endpoint. If the desired network isn't available be sure to change the region in the Deployment Details section above.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(filter(steps('imageCustomizations').logging.virtualNetworksApi.value, (item) => equals(item.location, steps('basics').scope.location.name)), (item) => parse(concat('{\"label\":\"', item.name, '\",\"description\":\"Resource group: ', first(skip(split(item.id, '/'), 4)), '\",\"value\":\"', item.id, '\"}')))]"
									}
								},
								{
									"name": "subnetsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('imageCustomizations').logging.virtualNetwork, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "subnet",
									"type": "Microsoft.Common.DropDown",
									"visible": "[if(equals(steps('imageCustomizations').logging.collectLogs, true),true, false)]",
									"label": "Subnet",
									"defaultValue": "",
									"toolTip": "Select an existing subnet for the image capture.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(steps('imageCustomizations').logging.subnetsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\"}')))]"
									}
								},
								                                {
                                    "name": "infoAzureDNSzones",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": "[if(equals(steps('imageCustomizations').logging.collectLogs, true),true, false)]",
                                    "options": {
                                        "text": "Private DNS zone name spaces: <br/> Azure Blobs <br/> - Azure commercial: privatelink.blob.core.windows.net <br/> - Azure government: privatelink.blob.core.usgovcloudapi.net",
                                        "style": "info"
                                    }
                                },
								{
                                    "name": "privateDnsZoneBlobStorageSelector",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Blob Storage Private Dns Zone",
                                    "resourceType": "Microsoft.Network/privateDnsZones",
                                    "constraints": {
                                        "required": true
                                    },
									"visible": "[if(equals(steps('imageCustomizations').logging.collectLogs, true),true, false)]"
                                }
							]
						}
					]
				},
				{
					"name": "imageDest",
					"label": "Image Distribution Options",
					"elements": [
						{
							"name": "info",
							"type": "Microsoft.Common.TextBlock",
							"visible": true,
							"options": {
								"text": "For image management, this solution will create a new image version of a image (definition) in the Azure Compute Gallery selected on the Basics tab. You have the option to use an existing image definiton or define a new one.",
								"link": {
									"label": "Learn more about managing images with an Azure Compute Gallery.",
									"uri": "https://learn.microsoft.com/en-us/azure/virtual-machines/windows/image-builder-gallery"
								}
							}
						},
						{
							"name": "imageDefinition",
							"type": "Microsoft.Common.Section",
							"visible": true,
							"label": "Image Definition Details",
							"elements": [
								{
									"name": "useExImageDef",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Use Existing Image Definition",
									"defaultValue": "Yes",
									"toolTip": "Determines if you want to use an existing image definition from the Azure Compute Gallery selected on the 'Prerequisites' page or create a new one.",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "warningBox",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, true)]",
									"options": {
										"style": "Warning",
										"text": "The image definition you choose below must have the appropriate features selected for the security type and accelerated networking that you picked on the 'Image Virtual Machine' page."
									}
								},
								{
                                    "name": "imagesApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('prereqs').gallery.gallery.id, '/images?api-version=2022-03-03')]"
                                    }
                                },
                                {
                                    "name": "imageDefinition",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Image Definition",
                                    "multiselect": false,
                                    "defaultValue": "",
                                    "toolTip": "Select the existing image definition for which a new image version will be selected. If the desired image definition is not available, check your Compute Gallery selection on the 'Prerequisites' page or select to create a new one above.",
                                    "filterPlaceholder": "",
                                    "defaultDescription": "",
                                    "constraints": {
                                        "allowedValues": "[map(steps('imageDest').imageDefinition.imagesApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
                                        "required": true
                                    },
                                    "visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, true)]"
                                },
								{
									"name": "textBlockImageDefinition",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, false)]",
									"options": {
										"text": "Use the first text box below to provide a custom name for the image definition, if desired. If you leave the custom name blank, then the image definition name will be created based on the 'publisher', 'offer', and 'sku' provided below using CAF naming standards."
									}
								},
								{
									"name": "customImageDefinitionName",
									"type": "Microsoft.Common.TextBox",
									"label": "Custom Image Definition Name",
									"placeholder": "vmid-<imagePublisher>-<imageOffer>-<imageSku>-<environment>-<location>",
									"toolTip": "The name of the image definition to create in the Image Gallery. Leave blank if you want to allow this deployment to create an image definition in the Image Gallery chosen on the 'Prerequisites' page with a name based on the selections below.",
									"constraints": {
										"required": false,
										"regex": "^[a-z0-9A-Z-]{2,80}$",
										"validationMessage": "When provided, the name must be between 2 and 80 characters long and only use valid characters."
									},
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, false)]"
								},
								{
									"name": "imageDefinitionPublisher",
									"type": "Microsoft.Common.TextBox",
									"label": "Image Definition Publisher",
									"subLabel": "",     
									"defaultValue": "[first(split(steps('imageVm').vmProps.osVersion, '_'))]",
									"toolTip": "The compute gallery image definition Publisher.",
									"constraints": {
										"required": true,
										"regex": "^[A-Za-z0-9][A-Za-z0-9_-]{0,126}[A-Za-z0-9]$",
										"validationMessage": "The value must contain only valid characters, no spaces, and be between 2 and 128 characters in length."
									},
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, false)]"
								},
								{
									"name": "imageDefinitionOffer",
									"type": "Microsoft.Common.TextBox",
									"label": "Image Definition Offer",
									"subLabel": "",
									"defaultValue": "[last(take(split(steps('imageVm').vmProps.osVersion, '_'), 2))]",
									"toolTip": "The compute gallery image definition Offer.",
									"constraints": {
										"required": true,
										"regex": "^[A-Za-z0-9][A-Za-z0-9_-]{0,62}[A-Za-z0-9]$",
										"validationMessage": "The value must contain only valid characters, no spaces, and be between 2 and 64 characters in length."
									},
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, false)]"
								},                        
								{
									"name": "imageDefinitionSku",
									"type": "Microsoft.Common.TextBox",
									"label": "Image Definition Sku",
									"subLabel": "",
									"defaultValue": "[last(split(steps('imageVm').vmProps.osVersion, '_'))]",
									"toolTip": "The compute gallery image definition Sku.",
									"constraints": {
										"required": true,
										"regex": "^[A-Za-z0-9][A-Za-z0-9_-]{0,62}[A-Za-z0-9]$",
										"validationMessage": "The value must contain only valid characters, no spaces, and be between 2 and 64 characters in length."
									},
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, false)]"
								},
								{
									"name": "isAcceleratedNetworkSupported",
									"type": "Microsoft.Common.DropDown",
									"label": "Accelerated Networking Supported (Preview)",
									"defaultValue": "Yes",
									"toolTip": "Set to 'Yes' to allow Virtual Machines deployed from the image to use Accelerated Networking. When set to 'Yes' on the Image definition, capturing VMs that don't support accelerated networking is not supported.",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									},
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, false)]"
								},
								{
                                    "name": "isHibernateSupported",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Hibernation Supported (preview)",
                                    "defaultValue": "No",
                                    "toolTip": "Set this to 'Yes' to enable Virtual Machines to be deployed from this image definition that support hibernation.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Yes",
                                                "value": true
                                            },
                                            {
                                                "label": "No",
                                                "value": false
                                            }
                                        ]
                                    },
									"visible": "[and(equals(steps('imageDest').imageDefinition.useExImageDef, false),or(contains(steps('imageVm').vmProps.osVersion, 'g2'), contains(steps('imageVm').vmProps.osVersion, 'win11')))]"
                                },
								{
                                    "name": "securityType",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Security type",
                                    "defaultValue": "Trusted Launch Supported",
                                    "toolTip": "Choose a type of security that matches your needs: Standard includes basic protections at no additional cost. Trusted launch virtual machines provide additional security features on Gen2 virtual machines to protect against persistent and advanced attacks.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Standard",
                                                "value": "Standard"
                                            },
                                            {
                                                "label": "Trusted Launch",
                                                "value": "TrustedLaunch"
                                            },
											{
                                                "label": "Trusted Launch Supported",
                                                "value": "TrustedLaunchSupported"
                                            },
                                            {
                                                "label": "Confidential VM",
                                                "value": "ConfidentialVM"
                                            },
											{
                                                "label": "Confidential VM Supported",
                                                "value": "ConfidentialVMSupported"
                                            },
											{
												"label": "Trusted Launch and Confidential VM Supported",
												"value": "TrustedLaunchAndConfidentialVmSupported"
											}
                                        ]
                                    },
									"visible": "[and(equals(steps('imageDest').imageDefinition.useExImageDef, false),or(contains(steps('imageVm').vmProps.osVersion, 'g2'), contains(steps('imageVm').vmProps.osVersion, 'win11')))]"
                                },
								{
                                    "name": "isNVMeSupported",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Higher storage performance with NVMe (preview)",
                                    "defaultValue": "No",
                                    "toolTip": "Set this to 'Yes' to enable the capture of VMs and disks on NVMe storage.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Yes",
                                                "value": true
                                            },
                                            {
                                                "label": "No",
                                                "value": false
                                            }
                                        ]
                                    },
									"visible": "[and(equals(steps('imageDest').imageDefinition.useExImageDef, false),or(contains(steps('imageVm').vmProps.osVersion, 'g2'), contains(steps('imageVm').vmProps.osVersion, 'win11')))]"
                                }
							]
						
						},
						{
							"name": "imageVersion",
							"type": "Microsoft.Common.Section",
							"label": "Image Version Details",
							"elements": [
								{
									"name": "useCustomVersion",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Specify Custom Version Information",
									"defaultValue": "No",
									"toolTip": "Select 'Yes' to specify the Major.Minor.Patch version information or 'No' to generate the Image Version based on the Date and Time (i.e., yy.MMdd.mmss).",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									}
								},
								{
									"name": "imageMajorVersion",
									"type": "Microsoft.Common.Slider",
									"label": "Image Major Version",
									"subLabel": "",
									"min": 1,
									"max": 9999,
									"showStepMarkers": false,
									"toolTip": "Pick the first component of the image version",
									"constraints": {
										"required": true
									},									
									"visible": "[equals(steps('imageDest').imageVersion.useCustomVersion, true)]"
								},
								{
									"name": "imageMinorVersion",
									"type": "Microsoft.Common.Slider",
									"label": "Image Minor Version",
									"subLabel": "",
									"min": 1,
									"max": 9999,
									"showStepMarkers": false,
									"toolTip": "Pick the second component of the image version",
									"constraints": {
										"required": true
									},									
									"visible": "[equals(steps('imageDest').imageVersion.useCustomVersion, true)]"
								},
								{
									"name": "imagePatch",
									"type": "Microsoft.Common.Slider",
									"label": "Image Patch",
									"subLabel": "",
									"min": 1,
									"max": 9999,
									"showStepMarkers": false,
									"toolTip": "Pick the last component of the image version",
									"constraints": {
										"required": true
									},									
									"visible": "[equals(steps('imageDest').imageVersion.useCustomVersion, true)]"
								},
								{
									"name": "eolDaysFromNow",
									"type": "Microsoft.Common.Slider",
									"label": "End of Life from today in days",
									"subLabel": "",
									"min": 0,
									"max": 730,
									"showStepMarkers": false,
									"toolTip": "Enter the number of days before this image version should be replaced.",
									"constraints": {
										"required": false
									},									
									"visible": true
								},
								{
									"name": "storageAccountType",
									"type": "Microsoft.Common.DropDown",
									"label": "Default Storage Account Type",
									"defaultValue": "Standard LRS",
									"toolTip": "Select the default storage account type for this image version. If you don't specify additional replication regions, then this value will be used with the deployment location.",
									"constraints": {
										"allowedValues": [
											{
												"label": "Standard LRS",
												"value": "Standard_LRS"
											},
											{
												"label": "Standard ZRS",
												"value": "Standard_ZRS"
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "replicaCount",
									"type": "Microsoft.Common.Slider",
									"label": "Default Replica Count",
									"subLabel": "",
									"defaultValue": 1,
									"min": 1,
									"max": 100,
									"showStepMarkers": false,
									"toolTip": "Specify the default replica count per region for this image version. If you don't specify additional replication regions, then this value will be used with the deployment location.",
									"constraints": {
										"required": true
									},									
									"visible": true
								},
								{
									"name": "excludeFromLatest",
									"type": "Microsoft.Common.DropDown",
									"label": "Exclude from Latest",
									"defaultValue": "No",
									"toolTip": "Select the default value for Exclude from Latest which determines whether this image version will be used when a image resource id uses 'latest' for the version. If you don't specify additional replication regions, then this value will be used with the deployment location.",
									"constraints": {
										"allowedValues": [
											{
												"label": "No",
												"value": false
											},
											{
												"label": "Yes",
												"value": true
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "specifyReplicationRegions",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Specify more than one location where the image version should be stored?",
									"defaultValue": "No",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									}
								},
								{
									"name": "defaultReplicationRegion",
									"type": "Microsoft.Common.DropDown",
									"label": "Default Image Location",
									"placeholder": "",
									"defaultValue": "[steps('basics').scope.location.displayName]",
									"toolTip": "",
									"constraints": {
										"allowedValues": "[if(equals(steps('imageDest').imageVersion.storageAccountType, 'Standard_LRS'), map(first(map(filter(steps('basics').computeApi.value, (resourceTypes) => equals(resourceTypes.resourceType, 'galleries/images/versions')), (item) => item.locations)), (item) => parse(concat('{\"label\":\"', item, '\",\"value\":\"', toLower(replace(item, ' ', '')), '\"}'))), map(filter(first(map(filter(steps('basics').storageApi.value, (resourceTypes) => equals(resourceTypes.resourceType, 'storageAccounts')), (item) => item.zoneMappings)), (item) => equals(length(item.zones), 3)), (item) => parse(concat('{\"label\":\"', item.location, '\",\"value\":\"', toLower(replace(item.location, ' ', '')), '\"}'))))]",
										"required": true
									},
									"visible": "[if(equals(steps('imageDest').imageVersion.specifyReplicationRegions, true), false, true)]"
								},
								{
									"name": "repRegionsText",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[if(equals(steps('imageDest').imageVersion.specifyReplicationRegions, true), true, false)]",
									"options": {
										"text": "Use the grid below to add All replication regions and the associated values. To add rows, toggle one of the drop down boxes."
									}
								},
								{
									"name": "replicationRegions",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Replication Regions",
									"label": "Replication Regions",
									"visible": "[if(equals(steps('imageDest').imageVersion.specifyReplicationRegions, true), true, false)]",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 0,
												"max": 10
											}
										},
										"columns": [
											{
												"id": "storageAccountType",
												"header": "Storage account type",
												"width": "2fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"required": true,
														"allowedValues": [
															{
																"label": "Standard LRS",
																"value": "Standard_LRS"
															},
															{
																"label": "Standard ZRS",
																"value": "Standard_ZRS"
															}
														]
													}
												}
											},
											{
												"id": "name",
												"header": "Region",
												"width": "2fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": "[if(equals(last(take(steps('imageDest').imageVersion.replicationRegions, $rowIndex)).storageAccountType, 'Standard_LRS'), map(first(map(filter(steps('basics').computeApi.value, (resourceTypes) => equals(resourceTypes.resourceType, 'galleries/images/versions')), (item) => item.locations)), (item) => parse(concat('{\"label\":\"', item, '\",\"value\":\"', toLower(replace(item, ' ', '')), '\"}'))), map(filter(first(map(filter(steps('basics').storageApi.value, (resourceTypes) => equals(resourceTypes.resourceType, 'storageAccounts')), (item) => item.zoneMappings)), (item) => equals(length(item.zones), 3)), (item) => parse(concat('{\"label\":\"', item.location, '\",\"value\":\"', toLower(replace(item.location, ' ', '')), '\"}'))))]",
														"required": true
													}
												}
											},
											{
												"id": "regionalReplicaCount",
												"header": "Replica Count",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"constraints": {
														"validations": [
															{
																"regex": "^[1-9]$|^[1-9][0-9]$|^100$",
																"message": "Only integers are allowed from 1-100"
															}
														],
														"required": true
													}
												}
											},
											{
												"id": "excludeFromLatest",
												"header": "Exclude from Latest",
												"width": "2fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "No",
																"value": false
															},
															{
																"label": "Yes",
																"value": true
															}															
														],
														"required": true
													}
												}
											}
										]
									}
								}
							]
                        }
					]
				}
			]
        },
        "outputs": {
            "kind": "Subscription",
            "location": "[steps('basics').scope.location.name]",
            "subscriptionId": "[steps('basics').scope.subscription.id]",
            "parameters": {
				"deploymentLocation": "[steps('basics').scope.location.name]",
                "deploymentPrefix": "[steps('basics').deploymentSpecs.deploymentPrefix]",
                "envClassification": "[steps('basics').deploymentSpecs.envClassification]",
				"imageBuildResourceGroupId": "[if(equals(steps('basics').resGroup.useExResGroup, true), concat(steps('basics').scope.subscription.id, '/resourceGroups/',steps('basics').resGroup.resourceGroup), '')]",
				"customBuildResourceGroupName": "[if(equals(steps('basics').resGroup.useExResGroup, false), steps('basics').resGroup.customBuildResourceGroupName, '')]",
				"computeGalleryResourceId": "[steps('prereqs').gallery.gallery.id]",
				"storageAccountResourceId": "[steps('prereqs').storage.storageAccount.id]",
				"containerName": "[first(skip(split(steps('prereqs').storage.container, '/'), 12))]",
				"userAssignedIdentityResourceId": "[steps('prereqs').storage.managedIdentity.id]",
				"subnetResourceId": "[steps('prereqs').network.subnet]",				
				"vmSize": "[steps('imageVm').vmProps.vmSize]",
                "publisher": "[first(split(steps('imageVm').vmProps.osVersion, '_'))]",
                "offer": "[last(take(split(steps('imageVm').vmProps.osVersion, '_'), 2))]",
                "sku": "[last(split(steps('imageVm').vmProps.osVersion, '_'))]",
				"customizations": "[if(equals(steps('imageCustomizations').customSoftware.addCustomSoftware, true), steps('imageCustomizations').customSoftware.customizations, '')]",
				"installAccess": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.installAccess,'false')]",
                "installExcel": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.installExcel,'false')]",
				"installOneDrive": "[steps('imageCustomizations').office.installOneDrive]",
                "installOneNote": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.installOneNote,'false')]",
                "installOutlook": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.installOutlook,'false')]",
                "installPowerPoint": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.installPowerPoint,'false')]",
                "installProject": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.installProject,'false')]",
                "installPublisher": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.installPublisher,'false')]",
                "installSkypeForBusiness": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.installSkypeForBusiness,'false')]",
                "installTeams": "[steps('imageCustomizations').office.installTeams]",
                "installVirtualDesktopOptimizationTool": "[steps('imageCustomizations').office.installVirtualDesktopOptimizationTool]",
                "installVisio": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.installVisio,'false')]",
                "installWord": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.installWord,'false')]",
				"vDotBlobName": "[if(equals(steps('imageCustomizations').office.installVirtualDesktopOptimizationTool, true), steps('imageCustomizations').office.vDotBlob.blobName,'')]",
                "officeBlobName": "[if(equals(steps('imageCustomizations').office.installOffice, true), steps('imageCustomizations').office.officeBlob.blobName,'')]",
				"onedriveBlobName": "[if(equals(steps('imageCustomizations').office.installOneDrive, true), steps('imageCustomizations').office.onedriveBlob.blobName,'')]",
                "teamsBlobName": "[if(equals(steps('imageCustomizations').office.installTeams, true), steps('imageCustomizations').office.teamsBlob.blobName,'')]",
				"installUpdates": "[steps('imageCustomizations').updates.installUpdates]",
				"updateService": "[steps('imageCustomizations').updates.updateService]",
				"wsusServer": "[if(equals(steps('imageCustomizations').updates.updateService, 'WSUS'), steps('imageCustomizations').updates.wsusServer, '')]",
				"collectCustomizationLogs": "[steps('imageCustomizations').logging.collectLogs]",
				"privateEndpointSubnetResourceId": "[if(equals(steps('imageCustomizations').logging.collectLogs, true), steps('imageCustomizations').logging.subnet, '')]",
				"blobPrivateDnsZoneResourceId": "[if(equals(steps('imageCustomizations').logging.collectLogs, true), steps('imageCustomizations').logging.privateDnsZoneBlobStorageSelector.id, '')]",	
				"imageDefinitionResourceId": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, true), concat(steps('prereqs').gallery.gallery.id, '/images/', steps('imageDest').imageDefinition.imageDefinition), '')]",
				"customImageDefinitionName": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.customImageDefinitionName, '')]",
				"imageDefinitionPublisher": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.imageDefinitionPublisher, '')]",
				"imageDefinitionOffer": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.imageDefinitionOffer, '')]",
				"imageDefinitionSku": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.imageDefinitionSku, '')]",
				"imageDefinitionIsAcceleratedNetworkSupported": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.isAcceleratedNetworkSupported, false)]",
				"imageDefinitionIsHibernateSupported": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.isHibernateSupported, false)]",
				"imageDefinitionSecurityType": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.securityType, 'Standard')]",
				"imageDefinitionIsHigherStoragePerformanceSupported": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.isNVMeSupported, false)]",
				"imageMajorVersion": "[if(equals(steps('imageDest').imageVersion.useCustomVersion, true), steps('imageDest').imageVersion.imageMajorVersion, -1)]",
				"imageMinorVersion": "[if(equals(steps('imageDest').imageVersion.useCustomVersion, true), steps('imageDest').imageVersion.imageMinorVersion, -1)]",
				"imagePatch": "[if(equals(steps('imageDest').imageVersion.useCustomVersion, true), steps('imageDest').imageVersion.imagePatch, -1)]",
				"imageVersionEOLinDays": "[steps('imageDest').imageVersion.eolDaysFromNow]",
				"imageVersionExcludeFromLatest": "[steps('imageDest').imageVersion.excludeFromLatest]",
				"imageVersionDefaultReplicaCount": "[steps('imageDest').imageVersion.replicaCount]",
				"imageVersionDefaultStorageAccountType": "[steps('imageDest').imageVersion.storageAccountType]",
				"imageVersionDefaultRegion": "[if(equals(steps('imageDest').imageVersion.specifyReplicationRegions, false), steps('imageDest').imageVersion.defaultReplicationRegion, '')]",
				"imageVersionTargetRegions": "[if(equals(steps('imageDest').imageVersion.specifyReplicationRegions, true), steps('imageDest').imageVersion.replicationRegions, parse('[]'))]"
            }
        }
    }
}