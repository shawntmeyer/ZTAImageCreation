{
    "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "Custom Image Build",
            "steps": [
                {
                    "name": "basics",
                    "label": "Deployment Basics",
                    "elements": [
						{
							"name": "infoPreReq",
							"type": "Microsoft.Common.InfoBox",
							"visible": true,
							"options": {
								"style": "Info",
								"text": "PREREQUISITES REQUIRED \n\nThere are prerequisites that must be setup in your Azure environment to successfully deploy this Custom Image Build. Click here to review the prerequisites in the Getting Started guide.",
								"uri": "https://www.microsoft.com"
							}
						},
						{
                            "name": "scope",
                            "type": "Microsoft.Common.ResourceScope",
							"instanceDetailsLabel": "Image Build Location",
                            "location": {
								"label": "Region where temporary Image Build resources are created",
                                "resourceTypes": ["Microsoft.Compute/virtualmachines"]
                            }
                        },
						{
							"name": "resGroup",
							"type": "Microsoft.Common.Section",
							"label": "Image Build Resource Group",
							"elements": [
								{
									"name": "useExResGroup",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Use Existing Resource Group",
									"defaultValue": "Yes",
									"toolTip": "",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									}
								},
								{
                                    "name": "resourceGroupsApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('basics').scope.subscription.id, '/resourceGroups?api-version=2021-04-01')]"
                                    }
                                },
                                {
                                    "name": "resourceGroup",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Resource Group into which temporary Image Build resources are created.",
                                    "multiselect": false,
                                    "defaultValue": "",
                                    "toolTip": "Select the name of the existing resource group where the image build virtual machines and associated resources will be created.",
                                    "filterPlaceholder": "",
                                    "defaultDescription": "",
                                    "constraints": {
                                        "allowedValues": "[map(steps('basics').resGroup.resourceGroupsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
                                        "required": true
                                    },
                                    "visible": "[equals(steps('basics').resGroup.useExResGroup, true)]"
                                },
								{
									"name": "customBuildResourceGroupName",
									"type": "Microsoft.Common.TextBox",
									"label": "Custom Build Resource Group Name",
									"subLabel": "Leave blank if you want to allow this deployment to create a resource group automatically named with CAF principals.",
									"placeholder": "rg-image-build-resources-<environment>-<location>",
									"toolTip": "The custom name of the resource group where the image build and management vms will be created.",
									"constraints": {
										"required": false,
										"regex": "^[a-z0-9A-Z-]{2,90}$",
										"validationMessage": "If provided the value must be between 2 and 90 characters."
									},
									"visible": "[equals(steps('basics').resGroup.useExResGroup, false)]"
								}
							]
						},
						{
                            "name": "computeApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "[concat(steps('basics').scope.subscription.id,'/providers/Microsoft.Compute/resourceTypes?api-version=2021-04-01')]"
                            }
                        },
                        {
                            "name": "locationsApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "[concat(steps('basics').scope.subscription.id,'/locations?api-version=2020-01-01')]"
                            }
                        },
                        {
                            "name": "storageApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "[concat(steps('basics').scope.subscription.id,'/providers/Microsoft.Storage/resourceTypes?api-version=2021-04-01')]"
                            }
                        },
						{
							"name": "deploymentSpecs",
							"type":"Microsoft.Common.Section",
							"visible": true,
							"label": "Deployment Specifications",
							"elements":[
								{
									"name": "deploymentPrefix",
									"type": "Microsoft.Common.TextBox",
									"label": "Deployment Prefix",
									"subLabel": "",
									"placeholder": "imgbld",
									"toolTip": "Provide a prefix (from 2 to 6 characters) for the deployments created by this template.",
									"constraints": {
										"required": true,
										"regex": "^[a-z0-9A-Z-]{2,6}$",
										"validationMessage": "The prefix must be between 2 and 6 characters"
									}
								},                       
								{
									"name": "envClassification",
									"type": "Microsoft.Common.DropDown",
									"label": "Env Classification",
									"defaultValue": "Not Defined",
									"toolTip": "Select the type of environment (Development (Dev), Test (Test), Production (Prod)) for which this solution is being deployed. This information will be use as part of the resources naming. Select (or leave the value as) \"Not Specified\" to omit this option.",
									"constraints": {
										"required": false,
										"allowedValues": [
											{
												"label": "Not Defined",
												"value": ""
											},
											{
												"label": "Development",
												"value": "Dev"
											},
											{
												"label": "Test",
												"value": "Test"
											},
											{
												"label": "Production",
												"value": "Prod"
											}
										]
									}
								}
							]
						}
					]
				},
				{
					"name": "prereqs",
					"label": "Imaging Prerequisites and Resources",
					"elements": [
						{
							"name": "infoPreReq",
							"type": "Microsoft.Common.InfoBox",
							"options": {
								"style":"Warning",
								"text": "Prior to deployment, make sure you meet the prerequisites outlined in the resource pre-reqs section in Zero Trust Image solution documentation:",
								"uri": "https://github.com/mikedzikowski/ZTAImage#prequisites"
							}
						},
						{
							"name": "storage",
							"type": "Microsoft.Common.Section",
							"label": "Storage Account",
							"elements": [
								{
									"name": "storageAccount",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "Image Artifacts Storage Account",
									"resourceType": "Microsoft.Storage/storageAccounts",
									"toolTip": "Select the storage account containing the image customization artifacts (i.e., installers, scripts)."
								},
								{
									"name": "containerApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('prereqs').storage.storageAccount.id, '/blobServices/default/containers?api-version=2023-01-01')]"
									}
								},
								{
									"name": "container",
									"type": "Microsoft.Common.DropDown",
									"visible": true,
									"label": "Image Assets Container",
									"defaultValue": "",
									"toolTip": "Select the container which contains the image asset blobs.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(steps('prereqs').storage.containerApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\"}')))]"
									}
								},
								{
									"name": "managedIdentity",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "User Assigned Identity",
									"toolTip": "Select an existing User Assigned Identity with at least 'Storage Blob Data Reader Rights' to the storage account and container selected above.",
									"resourceType": "Microsoft.ManagedIdentity/userAssignedIdentities",
									"constraints": {
										"required": true
									}
								}
							]
						},
						{
							"name": "network",
							"type": "Microsoft.Common.Section",
							"label": "Networking",
							"elements": [
								{
									"name": "virtualNetworksApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('basics').scope.subscription.id, '/providers/Microsoft.Network/virtualNetworks?api-version=2022-11-01')]"
									}
								},
								{
									"name": "virtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"visible": true,
									"label": "Virtual Network",
									"defaultValue": "",
									"toolTip": "Select an existing virtual network for image capture. If the desired network isn't available be sure to change the region in the Deployment Details section above.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(filter(steps('prereqs').network.virtualNetworksApi.value, (item) => equals(item.location, steps('basics').scope.location.name)), (item) => parse(concat('{\"label\":\"', item.name, '\",\"description\":\"Resource group: ', first(skip(split(item.id, '/'), 4)), '\",\"value\":\"', item.id, '\"}')))]"
									}
								},
								{
									"name": "subnetsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('prereqs').network.virtualNetwork, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "subnet",
									"type": "Microsoft.Common.DropDown",
									"visible": true,
									"label": "Subnet",
									"defaultValue": "",
									"toolTip": "Select an existing subnet for the image capture.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(steps('prereqs').network.subnetsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\"}')))]"
									}
								}
							]
						},
						{
							"name": "gallery",
							"type": "Microsoft.Common.Section",
							"label": "Azure Compute Gallery",
							"elements": [
								{
									"name": "gallery",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "Select the existing Compute Gallery",
									"resourceType": "Microsoft.Compute/galleries"
								}
							]
						}				
					]
				},
				{
					"name": "imageVm",
					"label": "Image Virtual Machine",
					"elements": [
						{
							"name": "vmProps",
							"type": "Microsoft.Common.Section",
							"label": "Virtual Machine Properties",
							"elements": [
                        		{
									"name": "vmSize",
									"type": "Microsoft.Compute.SizeSelector",
									"label": "Virtual Machine Size",
									"toolTip": "",
									"recommendedSizes": [
										"Standard_D4ads_v5"
									],
									"options": {
										"hideDiskTypeFilter": false
									},
									"osPlatform": "Windows",							
									"visible": true
								},
								{
                                    "name": "osVersion",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Operating System Version",
                                    "filter": true,
                                    "defaultValue": "Windows 11 22H2 (Gen2)",
                                    "toolTip": "Select the operating system version for the source image.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
											{
                                                "label": "Windows 10 22H2 Enterprise (Gen1)",
                                                "value": "MicrosoftWindowsDesktop_windows-10_win10-22h2-ent"
                                            },                                            
											{
                                                "label": "Windows 10 22H2 Multi-Session (Gen1)",
                                                "value": "MicrosoftWindowsDesktop_windows-10_win10-22h2-avd"
                                            },
                                            {
                                                "label": "Windows 10 22H2 Multi-Session with M365 Apps (Gen1)",
                                                "value": "MicrosoftWindowsDesktop_office-365_win10-22h2-avd-m365"
                                            },
											{
                                                "label": "Windows 10 22H2 Enterprise (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-10_win10-22h2-ent-g2"
                                            },                                            
											{
                                                "label": "Windows 10 22H2 Multi-Session (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-10_win10-22h2-avd-g2"
                                            },
                                            {
                                                "label": "Windows 10 22H2 Multi-Session with M365 Apps (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_office-365_win10-22h2-avd-m365-g2"
                                            },
											{
                                                "label": "Windows 11 21H2 Enterprise (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-11_win11-21h2-ent"
                                            },                                            
											{
                                                "label": "Windows 11 21H2 Multi-Session (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-11_win11-21h2-avd"
                                            },
                                            {
                                                "label": "Windows 11 21H2 Multi-Session with M365 Apps (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_office-365_win11-21h2-avd-m365"
                                            },
																						{
                                                "label": "Windows 11 22H2 Enterprise (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-11_win11-22h2-ent"
                                            },                                            
											{
                                                "label": "Windows 11 22H2 Multi-Session (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_windows-11_win11-22h2-avd"
                                            },
                                            {
                                                "label": "Windows 11 22H2 Multi-Session with M365 Apps (Gen2)",
                                                "value": "MicrosoftWindowsDesktop_office-365_win11-22h2-avd-m365"
                                            }
                                        ]
                                    }
                                },
								{
                                    "name": "imageDefinitionFeatureWarning",
                                    "type": "Microsoft.Common.InfoBox",
                                    "options": {
                                        "text": "If you specify to use an existing Azure Compute Gallery Image Definition on the 'Image Distribution Options' page, then image definition features must be configured with the Security Type and Accelerated Networking set to the appropriate values based on your selections below.<br/><br/>You can determine if the image definition supports the required feature by reviewing the 'Properties' tab on the 'Overview' node of the Gallery Image Definition in the portal. If the image definition does not contain these feature options, then the deployment will fail.<br/><br/>If you chose to create a new image definition, it will be configured automatically.",
                                        "uri": "https://learn.microsoft.com/azure/templates/microsoft.compute/galleries/images?pivots=deployment-language-bicep",
                                        "style": "Warning"
                                    },
									"visible": true
                                },
								{
									"name": "enableAcceleratedNetworking",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Enable Accelerated Networking",
									"defaultValue": "Yes",
									"toolTip": "",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									},
									"visible": true
								},
                                {
                                    "name": "securityType",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Security type",
                                    "filter": true,
                                    "defaultValue": "Trusted Launch Virtual Machines",
                                    "toolTip": "Choose a type of security that matches your needs: Standard includes basic protections at no additional cost. Trusted launch virtual machines provide additional security features on Gen2 virtual machines to protect against persistent and advanced attacks.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Standard",
                                                "value": "Standard"
                                            },
                                            {
                                                "label": "Trusted Launch Virtual Machines",
                                                "value": "TrustedLaunch"
                                            },
                                            {
                                                "label": "Confidential Virtual Machines",
                                                "value": "ConfidentialVM"
                                            }
                                        ]
                                    },
									"visible": "[or(contains(steps('imageVm').vmProps.osVersion, 'g2'), contains(steps('imageVm').vmProps.osVersion, 'win11'))]"
                                }
							]							
						}						
					]
				},
				{
					"name": "imageCustomizations",
                    "label": "Image Customizations",
                    "elements": [
						{
							"name": "infoBox1",
							"type": "Microsoft.Common.InfoBox",
							"visible": true,
							"options": {
								"icon": "None",
								"style": "Info",
								"text": "This page of the wizard allows you to add image customizations by downloading blobs from the storage account and performing the defined actions."
							}
						},
						{
							"name": "customSoftware",
							"type": "Microsoft.Common.Section",
							"label": "Custom Software",
							"elements": [
								{
									"name": "addCustomSoftware",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Add Custom Software",
									"defaultValue": "No",
									"toolTip": "Select \"Yes\" to add custom software to the image",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "customizations",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Customizations",
									"label": "Custom Scripts and Software",
									"visible": "[steps('imageCustomizations').customSoftware.addCustomSoftware]",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 0,
												"max": 10
											}
										},
										"columns": [
											{
												"id": "name",
												"header": "Name",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "Example: vscode",
													"constraints": {
														"required": true,
														"validations": []
													}
												}
											},
											{
												"id": "blobname",
												"header": "Blobname",
												"width": "10fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "Example: VSCodeSetup-x64-1.81.1.exe",
													"constraints": {
														"allowedValues": [
															{
																"label": "blobname",
																"value": "text"
															}
														],
														"required": true
													}
												}
											},
											{
												"id": "arguments",
												"header": "Arguments",
												"width": "10fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "Example: /silent /mergetasks='!runcode'",
													"constraints": {
														"allowedValues": [
															{
																"label": "Arguments",
																"value": "text"
															}
														],
														"required": false 
													}
												}
											}
										]
									}
								}
							],
							"visible": true
						},
						{
							"name": "logging",
							"type": "Microsoft.Common.Section",
							"label": "Log Collection",
							"elements": [
								{
									"name": "infoBox",
									"type": "Microsoft.Common.InfoBox",
									"visible": true,
									"options": {
										"icon": "None",
										"style": "Info",
										"text": "If you choose to collect logs, a new randomly-named storage account will be created in the build resource group with a blob container called 'image-customization-logs'. All standard and error output will be written to individual blobs and saved for 7 days."
									}
								},
								{
									"name": "warningBox",
									"type": "Microsoft.Common.InfoBox",
									"visible": true,
									"options": {
										"icon": "None",
										"style": "Warning",
										"text": "In order to collect logs from the customization scripts and installers you must provide the subnet where the storage account private endpoint will be created and the blob storage private dns zone.",										"uri": "https://www.microsoft.com"
									}
								},
								{
									"name": "collectLogs",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Collect customization logs in a storage container",
									"defaultValue": "No",
									"toolTip": "",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "virtualNetworksApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('basics').scope.subscription.id, '/providers/Microsoft.Network/virtualNetworks?api-version=2022-11-01')]"
									}
								},
								{
									"name": "virtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"visible": "[if(equals(steps('imageCustomizations').logging.collectLogs, true),true, false)]",
									"label": "Virtual Network",
									"defaultValue": "",
									"toolTip": "Select an existing virtual network for the storage account blob private endpoint. If the desired network isn't available be sure to change the region in the Deployment Details section above.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(filter(steps('imageCustomizations').logging.virtualNetworksApi.value, (item) => equals(item.location, steps('basics').scope.location.name)), (item) => parse(concat('{\"label\":\"', item.name, '\",\"description\":\"Resource group: ', first(skip(split(item.id, '/'), 4)), '\",\"value\":\"', item.id, '\"}')))]"
									}
								},
								{
									"name": "subnetsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('imageCustomizations').logging.virtualNetwork, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "subnet",
									"type": "Microsoft.Common.DropDown",
									"visible": "[if(equals(steps('imageCustomizations').logging.collectLogs, true),true, false)]",
									"label": "Subnet",
									"defaultValue": "",
									"toolTip": "Select an existing subnet for the image capture.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(steps('imageCustomizations').logging.subnetsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\"}')))]"
									}
								},
								                                {
                                    "name": "infoAzureDNSzones",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": "[if(equals(steps('imageCustomizations').logging.collectLogs, true),true, false)]",
                                    "options": {
                                        "text": "Private DNS zone name spaces: <br/> Azure Blobs <br/> - Azure commercial: privatelink.blob.core.windows.net <br/> - Azure government: privatelink.blob.core.usgovcloudapi.net",
                                        "style": "info"
                                    }
                                },
								{
                                    "name": "privateDnsZoneBlobStorageSelector",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Blob Storage Private Dns Zone",
                                    "resourceType": "Microsoft.Network/privateDnsZones",
                                    "constraints": {
                                        "required": true
                                    },
									"visible": "[if(equals(steps('imageCustomizations').logging.collectLogs, true),true, false)]"
                                }
							]
						}
					]
				},
				{
					"name": "imageDest",
					"label": "Image Distribution Options",
					"elements": [
						{
							"name": "info",
							"type": "Microsoft.Common.TextBlock",
							"visible": true,
							"options": {
								"text": "For image management, this solution will create a new image version of a image (definition) in the Azure Compute Gallery selected on the Basics tab. You have the option to use an existing image definiton or define a new one.",
								"link": {
									"label": "Learn more about managing images with an Azure Compute Gallery.",
									"uri": "https://learn.microsoft.com/en-us/azure/virtual-machines/windows/image-builder-gallery"
								}
							}
						},
						{
							"name": "imageDefinition",
							"type": "Microsoft.Common.Section",
							"visible": true,
							"label": "Image Definition Details",
							"elements": [{
									"name": "useExImageDef",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Use Existing Image Definition",
									"defaultValue": "Yes",
									"toolTip": "Determines if you want to use an existing image definition from the Azure Compute Gallery selected on the 'Prerequisites' page or create a new one.",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "warningBox",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, true)]",
									"options": {
										"icon": "None",
										"style": "Warning",
										"text": "The image definition you choose below must have the appropriate features selected for the security type and accelerated networking that you picked on the 'Image Virtual Machine' page."
									}
								},
								{
                                    "name": "imagesApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('prereqs').gallery.gallery.id, '/images?api-version=2022-03-03')]"
                                    }
                                },
                                {
                                    "name": "imageDefinition",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Image Definition",
                                    "multiselect": false,
                                    "defaultValue": "",
                                    "toolTip": "Select the existing image definition for which a new image version will be selected. If the desired image definition is not available, check your Compute Gallery selection on the 'Prerequisites' page or select to create a new one above.",
                                    "filterPlaceholder": "",
                                    "defaultDescription": "",
                                    "constraints": {
                                        "allowedValues": "[map(steps('imageDest').imageDefinition.imagesApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
                                        "required": true
                                    },
                                    "visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, true)]"
                                },
								{
									"name": "customImageDefinitionName",
									"type": "Microsoft.Common.TextBox",
									"label": "Custom Image Definition Name",
									"subLabel": "Leave blank if you want to allow this deployment to create an image definition in the Image Gallery chosen on the 'Prerequisites' page with a name based on the selections below.",
									"placeholder": "vmid-<imagePublisher>-<imageOffer>-<imageSku>-<environment>-<location>",
									"toolTip": "The name of the image definition to create in the Image Gallery. Leave blank if you want to allow this deployment to create an image definition in the Image Gallery chosen on the 'Prerequisites' page with a name based on the selections below.",
									"constraints": {
										"required": false,
										"regex": "^[a-z0-9A-Z-]{2,90}$",
										"validationMessage": "When provided, the name must be between 2 and 90 characters long and only use valid characters."
									},
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, false)]"
								},
								{
									"name": "imageDefinitionPublisher",
									"type": "Microsoft.Common.TextBox",
									"label": "Image Definition Publisher",
									"subLabel": "",
									"defaultValue": "",
									"toolTip": "The compute gallery image definition Publisher.",
									"constraints": {
										"required": true,
										"regex": "^[a-z0-9A-Z-]{2,20}$",
										"validationMessage": "The value must contain only valid characters and be between 2 and 20 characters in length."
									},
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, false)]"
								},
								{
									"name": "imageDefinitionOffer",
									"type": "Microsoft.Common.TextBox",
									"label": "Image Definition Offer",
									"subLabel": "",
									"defaultValue": "",
									"toolTip": "The compute gallery image definition Offer.",
									"constraints": {
										"required": true,
										"regex": "^[a-z0-9A-Z-]{2,20}$",
										"validationMessage": "The value must contain only valid characters and be between 2 and 20 characters in length."
									},
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, false)]"
								},                        
								{
									"name": "imageDefinitionSku",
									"type": "Microsoft.Common.TextBox",
									"label": "Image Definition Sku",
									"subLabel": "",
									"defaultValue": "",
									"toolTip": "The compute gallery image definition Sku.",
									"constraints": {
										"required": true,
										"regex": "^[a-z0-9A-Z-]{2,20}$",
										"validationMessage": "The value must contain only valid characters and be between 2 and 20 characters in length."
									},
									"visible": "[equals(steps('imageDest').imageDefinition.useExImageDef, false)]"
								}
							]
						
						},
						{
							"name": "imageVersion",
							"type": "Microsoft.Common.Section",
							"label": "Image Version Details",
							"elements": [
								{
									"name": "useCustomVersion",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Specify Custom Version Information",
									"defaultValue": "No",
									"toolTip": "Select 'Yes' to specify the Major.Minor.Patch version information or 'No' to generate the Image Version based on the Date and Time (i.e., yy.MMdd.mmss).",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									}
								},
								{
									"name": "imageMajorVersion",
									"type": "Microsoft.Common.Slider",
									"label": "Image Major Version",
									"subLabel": "",
									"min": 1,
									"max": 9999,
									"showStepMarkers": false,
									"toolTip": "Pick the first component of the image version",
									"constraints": {
										"required": true
									},									
									"visible": "[equals(steps('imageDest').imageVersion.useCustomVersion, true)]"
								},
								{
									"name": "imageMinorVersion",
									"type": "Microsoft.Common.Slider",
									"label": "Image Minor Version",
									"subLabel": "",
									"min": 1,
									"max": 9999,
									"showStepMarkers": false,
									"toolTip": "Pick the second component of the image version",
									"constraints": {
										"required": true
									},									
									"visible": "[equals(steps('imageDest').imageVersion.useCustomVersion, true)]"
								},
								{
									"name": "imagePatch",
									"type": "Microsoft.Common.Slider",
									"label": "Image Patch",
									"subLabel": "",
									"min": 1,
									"max": 9999,
									"showStepMarkers": false,
									"toolTip": "Pick the last component of the image version",
									"constraints": {
										"required": true
									},									
									"visible": "[equals(steps('imageDest').imageVersion.useCustomVersion, true)]"
								},
								{
									"name": "excludeFromLatest",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Exclude this image version from latest",
									"defaultValue": "false",
									"toolTip": "Exclude the image version created by this process from the latest version for the image definition.",
									"constraints": {
										"allowedValues": [
											{
												"label": "true",
												"value": true
											},
											{
												"label": "false",
												"value": false
											}
										],
										"required": true
									}
                                },
								{
    								"name": "endOfLifeDate",
									"type": "Microsoft.Common.DatePicker",
									"label": "Image Version End of Life Date",
									"visible": true,
									"constraints": {
										"required": false
									}
								},
								{
									"name": "storageAccountType",
									"type": "Microsoft.Common.DropDown",
									"label": "Image Version Storage account type",
									"defaultValue": "Standard Locally-Redundant Storage",
									"toolTip": "Determine the performance and redundancy for the Image Version storage.",
									"constraints": {
										"required": true,
										"allowedValues": [
											{
												"label": "Standard Locally-Redundant Storage",
												"value": "Standard_LRS"
											},
											{
												"label": "Standard Zone-Redundant Storage",
												"value": "Standard_ZRS"
											}
										]
									}
								},
								{
									"name": "replicaCount",
									"type": "Microsoft.Common.Slider",
									"label": "Image replicas count (per region)",
									"subLabel": "",
									"min": 1,
									"max": 100,
									"showStepMarkers": false,
									"toolTip": "Pick the number of image replicas per region up to 100",
									"constraints": {
										"required": true
									},									
									"visible": true
								},
								{
                                    "name": "replicationRegions",
                                    "type": "Microsoft.Common.DropDown",
                                    "filter": true,
                                    "label": "Image Replication Regions",
									"multiLine": true,
									"multiselect": true,
                                    "defaultValue": "[steps('basics').scope.location.displayName]",
                                    "toolTip": "Select all the regions to where you want the image version to be replicated.",
                                    "constraints": {
                                        "allowedValues": "[if(equals(steps('imageDest').imageVersion.storageAccountType, 'Standard_LRS'), map(first(map(filter(steps('basics').computeApi.value, (resourceTypes) => equals(resourceTypes.resourceType, 'galleries/images/versions')), (item) => item.locations)), (item) => parse(concat('{\"label\":\"', item, '\",\"value\":\"', toLower(replace(item, ' ', '')), '\"}'))), map(filter(first(map(filter(steps('basics').storageApi.value, (resourceTypes) => equals(resourceTypes.resourceType, 'storageAccounts')), (item) => item.zoneMappings)), (item) => equals(length(item.zones), 3)), (item) => parse(concat('{\"label\":\"', item.location, '\",\"value\":\"', toLower(replace(item.location, ' ', '')), '\"}'))))]",
                                        "required": true
                                    }
                                }
							]
                        }
					]
				}
			]
        },
        "outputs": {
            "kind": "Subscription",
            "location": "[steps('basics').scope.location.name]",
            "subscriptionId": "[steps('basics').scope.subscription.id]",
            "parameters": {
				"deploymentLocation": "[steps('basics').scope.location.name]",
                "deploymentPrefix": "[steps('basics').deploymentSpecs.deploymentPrefix]",
                "envClassification": "[steps('basics').deploymentSpecs.envClassification]",
				"imageBuildResourceGroupId": "[if(equals(steps('basics').resGroup.useExResGroup, true), steps('basics').resGroup.resourceGroup.id, '')]",
				"customBuildResourceGroupName": "[if(equals(steps('basics').resGroup.useExResGroup, false), steps('basics').resGroup.customBuildResourceGroupName, '')]",
				"computeGalleryResourceId": "[steps('prereqs').gallery.gallery.id]",
				"storageAccountResourceId": "[steps('prereqs').storage.storageAccount.id]",
				"containerName": "[first(skip(split(steps('prereqs').storage.container, '/'), 12))]",
				"userAssignedIdentityResourceId": "[steps('prereqs').storage.managedIdentity.id]",
				"subnetResourceId": "[steps('prereqs').network.subnet.id]",				
				"vmSize": "[steps('imageVm').vmProps.vmSize]",
                "publisher": "[first(split(steps('imageVm').vmProps.osVersion, '_'))]",
                "offer": "[last(take(split(steps('imageVm').vmProps.osVersion, '_'), 2))]",
                "sku": "[last(split(steps('imageVm').vmProps.osVersion, '_'))]",
				"enableAcceleratedNetworking": "[steps('imageVm').vmProps.enableAcceleratedNetworking]",
				"securityType": "[steps('imageVm').vmProps.securityType]",
				"customizations": "[if(equals(steps('imageCustomizations').customSoftware.addCustomSoftware, true), steps('imageCustomizations').customSoftware.customizations, '')]",
				"collectCustomizationLogs": "[steps('imageCustomizations').logging.collectLogs]",
				"privateEndpointSubnetResourceId": "[if(equals(steps('imageCustomizations').logging.collectLogs, true), steps('imageCustomizations').logging.subnet.id, '')]",
				"blobPrivateDnsZoneResourceId": "[if(equals(steps('imageCustomizations').logging.collectLogs, true), steps('imageCustomizations').logging.privateDnsZoneBlobStorageSelector.id, '')]",	
				"imageDefinitionResourceId": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, true), steps('imageDest').imageDefinition.imageDefinition.id, '')]",
				"customImageDefinitionName": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.customImageDefinitionName, '')]",
				"imageDefinitionPublisher": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.imageDefinitionPublisher, '')]",
				"imageDefinitionOffer": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.imageDefinitionOffer, '')]",
				"imageDefinitionSku": "[if(equals(steps('imageDest').imageDefinition.useExImageDef, false), steps('imageDest').imageDefinition.imageDefinitionSku, '')]",
				"imageMajorVersion": "[if(equals(steps('imageDest').imageVersion.useCustomVersion, true), steps('imageDest').imageVersion.imageMajorVersion, -1)]",
				"imageMinorVersion": "[if(equals(steps('imageDest').imageVersion.useCustomVersion, true), steps('imageDest').imageVersion.imageMinorVersion, -1)]",
				"imagePatch": "[if(equals(steps('imageDest').imageVersion.useCustomVersion, true), steps('imageDest').imageVersion.imagePatch, -1)]",
				"imageVersionEOLinDays": "[durationFormat(duration(utcNow(), steps('imageDest').imageVersion.endOfLifeDate), 'dd')]",
				"imageVersionExcludeFromLatest": "[steps('imageDest').imageVersion.excludeFromLatest]",
				"imageVersionStorageAccountType": "[steps('imageDest').imageVersion.storageAccountType]",
				"replicaCount": "[steps('imageDest').imageVersion.replicaCount]",
				"replicationRegions": "[steps('imageDest').imageVersion.replicationRegions]"
            }
        }
    }
}