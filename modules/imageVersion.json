{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.21.1.54444",
      "templateHash": "14388830644978126388"
    },
    "name": "Compute Galleries Image Version",
    "description": "This module deploys an Azure Compute Gallery Image Definition Version",
    "author": "shawn.meyer@microsoft.com"
  },
  "parameters": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "Required. Name of the image version."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Optional. Location for all resources."
      }
    },
    "imageName": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Conditional. The name of the parent Azure Shared Image Gallery Image Definition. Required if the template is used in a standalone deployment."
      }
    },
    "endOfLifeDate": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The end of life date as a string."
      }
    },
    "excludeFromLatest": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. If set to true, Virtual Machines deployed from the latest version of the Image Definition will not use this Image Version."
      }
    },
    "replicaCount": {
      "type": "int",
      "metadata": {
        "description": "Optional. The number of replicas of the Image Version to be created per region.\r\nThis property would take effect for a region when regionalReplicaCount is not specified. This property is updatable."
      }
    },
    "replicationMode": {
      "type": "string",
      "defaultValue": "",
      "allowedValues": [
        "",
        "Full",
        "Shallow"
      ],
      "metadata": {
        "description": "Optional. Optional parameter which specifies the mode to be used for replication. This property is not updatable."
      }
    },
    "storageAccountType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Premium_LRS",
        "Standard_LRS",
        "Standard_ZRS"
      ],
      "metadata": {
        "description": "Optional. Specifies the storage account type to be used to store the image. This property is not updatable."
      }
    },
    "targetRegions": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. The target regions where the Image Version is going to be replicated to.\r\nIf this object is not specified, then the deployment location will be used."
      }
    },
    "diskEncryptionSetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. A relative URI containing the resource ID of the disk encryption set."
      }
    },
    "confidentialVMEncryptionType": {
      "type": "string",
      "defaultValue": "",
      "allowedValues": [
        "",
        "EncryptedVMGuestStateOnlyWithPmk",
        "EncryptedWithCmk",
        "EncryptedWithPmk"
      ],
      "metadata": {
        "description": "Optional. Confidential VM encryption types"
      }
    },
    "secureVMDiskEncryptionSetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Secure VM disk encryption set id."
      }
    },
    "hostCaching": {
      "type": "string",
      "defaultValue": "None",
      "allowedValues": [
        "None",
        "ReadOnly",
        "ReadWrite"
      ],
      "metadata": {
        "description": "Optional. The host caching of the disk."
      }
    },
    "osDiskImageSourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The id of the gallery artifact version source. Can specify a disk uri, snapshot uri, user image or storage account resource."
      }
    },
    "osDiskImageSourceUri": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The uri of the gallery artifact version source. Currently used to specify vhd/blob source."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional. Tags for all resources."
      }
    }
  },
  "variables": {
    "targetRegionDefault": [
      {
        "encryption": "[if(not(empty(parameters('diskEncryptionSetId'))), createObject('osDiskImage', createObject('diskEncryptionSetId', parameters('diskEncryptionSetId'), 'securityProfile', createObject('confidentialVMEncryptionType', if(not(empty(parameters('confidentialVMEncryptionType'))), parameters('confidentialVMEncryptionType'), null()), 'secureVMDiskEncryptionSetId', if(not(empty(parameters('secureVMDiskEncryptionSetId'))), parameters('secureVMDiskEncryptionSetId'), null())))), null())]",
        "excludeFromLatest": "[parameters('excludeFromLatest')]",
        "name": "[parameters('location')]",
        "regionalReplicaCount": "[parameters('replicaCount')]",
        "storageAccountType": "[parameters('storageAccountType')]"
      }
    ]
  },
  "resources": [
    {
      "type": "Microsoft.Compute/galleries/images/versions",
      "apiVersion": "2022-03-03",
      "name": "[format('{0}/{1}/{2}', split(parameters('imageName'), '/')[0], split(parameters('imageName'), '/')[1], parameters('name'))]",
      "location": "[parameters('location')]",
      "properties": {
        "publishingProfile": {
          "endOfLifeDate": "[if(not(empty(parameters('endOfLifeDate'))), parameters('endOfLifeDate'), null())]",
          "excludeFromLatest": "[parameters('excludeFromLatest')]",
          "replicaCount": "[parameters('replicaCount')]",
          "replicationMode": "[if(not(empty(parameters('replicationMode'))), parameters('replicationMode'), null())]",
          "storageAccountType": "[parameters('storageAccountType')]",
          "targetRegions": "[if(not(empty(parameters('targetRegions'))), parameters('targetRegions'), variables('targetRegionDefault'))]"
        },
        "storageProfile": {
          "osDiskImage": {
            "hostCaching": "[parameters('hostCaching')]",
            "source": {
              "id": "[parameters('osDiskImageSourceId')]",
              "uri": "[parameters('osDiskImageSourceUri')]"
            }
          }
        }
      },
      "tags": "[parameters('tags')]"
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The resource group the image was deployed into."
      },
      "value": "[resourceGroup().name]"
    },
    "resourceId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the image version."
      },
      "value": "[resourceId('Microsoft.Compute/galleries/images/versions', split(parameters('imageName'), '/')[0], split(parameters('imageName'), '/')[1], parameters('name'))]"
    },
    "name": {
      "type": "string",
      "metadata": {
        "description": "The name of the image version."
      },
      "value": "[parameters('name')]"
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location the resource was deployed into."
      },
      "value": "[reference(resourceId('Microsoft.Compute/galleries/images/versions', split(parameters('imageName'), '/')[0], split(parameters('imageName'), '/')[1], parameters('name')), '2022-03-03', 'full').location]"
    }
  }
}